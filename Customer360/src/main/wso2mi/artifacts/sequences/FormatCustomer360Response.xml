<sequence name="FormatCustomer360Response" xmlns="http://ws.apache.org/ns/synapse">
    <variable name="crmInfo" type="JSON" expression="${payload[?(@.source=='CRM')].data}"/>
    <variable name="transactionInfo" type="JSON" expression="${payload[?(@.source=='Transactions')].data}"/>
    <variable name="supportInfo" type="JSON" expression="${payload[?(@.source=='Support')].data}"/>
    
    <payloadFactory media-type="json">
        <format>
            {
            "customerId": "${vars.customerId}",
            "timestamp": "${formatDateTime(now(), 'yyyy-MM-dd HH:mm:ss')}",
            "customer360": {
            "profile": ${vars.crmInfo},
            "purchaseHistory": ${vars.transactionInfo},
            "supportActivity": ${vars.supportInfo}
            }
            }
        </format>
    </payloadFactory>
</sequence>
